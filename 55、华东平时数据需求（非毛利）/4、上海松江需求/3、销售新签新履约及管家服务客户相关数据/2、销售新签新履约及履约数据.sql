-- ******************************************************************** 
-- @功能描述：
-- @创建者： 孔云 
-- @创建者日期：2025-07-31 11:30:57 
-- @修改者日期：
-- @修改人：
-- @修改内容：
-- ******************************************************************** 
-- 调整am内存
SET tez.am.resource.memory.mb=4096;
-- 调整container内存
SET hive.tez.container.size=8192;
-- --------------------------------------------------------------------------
-- ------------新签数据
drop table if exists csx_analyse_tmp.new_sign_customer;
create table if not exists csx_analyse_tmp.new_sign_customer as 
select
	a.sign_month,
	-- b.performance_province_name,
	-- b.performance_city_name,
	b.customer_code,
	max(b.customer_name) as customer_name,
	max(b.new_or_old_customer_mark) as new_or_old_customer_mark,
	max(b.first_sign_date) as first_sign_date,
	max(a.maxSignDate) as max_sign_date,
	max(a.signAmount) as sign_amount,
	max(b.first_category_name) as first_category_name,
	max(b.second_category_name) as second_category_name,
	max(b.third_category_name) as third_category_name,
	max(b.sales_user_number) as sales_user_number,
	max(b.sales_user_name) as sales_user_name,
	max(b.supervisor_user_number) as supervisor_user_number,
	max(b.supervisor_user_name) as supervisor_user_name,
	max(b.city_manager_user_number) as city_manager_user_number,
	max(b.city_manager_user_name) as city_manager_user_name,
	max(b.province_manager_user_number) as province_manager_user_number,
	max(b.province_manager_user_name) as province_manager_user_name  
from
(
    select
        customer_code,
        regexp_replace(substr(cast(business_sign_time as string),1,7),'-','') as sign_month,
        SUM(CAST(estimate_contract_amount AS DECIMAL(20,4))) as signAmount,
        count(business_number) as newSignBizOppCount,
        to_date(max(business_sign_time)) as maxSignDate,
        concat_ws(',', collect_set(cast(business_attribute_code as string))) as attribute,
        concat_ws(',', collect_set(business_attribute_name)) as bizOppAttributeName
    from csx_dim.csx_dim_crm_business_info  
    where sdt='current'
    and business_stage = 5 and business_attribute_code in (1,2,5) 
    and substr(cast(business_sign_time as string),1,7)>='2025-01'   
    and substr(cast(business_sign_time as string),1,7)<'2025-08'  
    and status=1 
    and customer_code not in ('154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'256560',
'256559',
'256557',
'256555',
'256551',
'256545',
'256548',
'256431',
'256430',
'256429',
'256428',
'256427',
'256426',
'205971',
'256425',
'256590',
'256423',
'256422',
'256442',
'256436',
'256440',
'256438',
'256434',
'256433',
'256439',
'256441',
'256437',
'256435',
'257771',
'257770',
'257769',
'257750',
'257814',
'257747',
'257768',
'257767',
'257766',
'257765',
'257764',
'257763',
'251674',
'251673',
'251675',
'251651',
'251653',
'251654',
'251649',
'251672',
'257762',
'256560',
'256559',
'256557',
'256555',
'256551',
'256545',
'256548',
'256431',
'256430',
'256429',
'256428',
'256427',
'256426',
'205971',
'256425',
'256590',
'256423',
'256442',
'256438',
'256433',
'256439',
'256437',
'256435',
'125268',
'256545',
'258773',
'258790',
'258782',
'258776',
'256438',
'256442',
'256559',
'256440',
'256548',
'256555',
'256436',
'258789',
'256560',
'256434',
'256557',
'258792',
'258780',
'256551',
'258791',
'258774',
'258775',
'256423',
'258777',
'256425',
'256433',
'258778',
'257764',
'256430',
'251649',
'257765',
'257766',
'251653',
'257768',
'257770',
'251675',
'251654',
'256431',
'256590',
'205971',
'257767',
'257771',
'257763',
'257769',
'251672',
'256426',
'256427',
'257750',
'257747',
'251651',
'179439',
'259969',
'259970',
'259971',
'259972',
'259973',
'256430',
'205971',
'256426',
'256429',
'256431',
'256590',
'260076',
'259974',
'259975',
'259976',
'259977',
'259978',
'259979',
'259980',
'259981',
'259982',
'259983',
'259984',
'259985',
'256427',
'256428',
'260097',
'260098',
'260100',
'260102',
'260104',
'260105',
'260106',
'260107',
'179439',
'259969',
'259970',
'259971',
'259972',
'259973',
'256430',
'154278',
'205971',
'256426',
'256429',
'256431',
'256590',
'265286',
'265287',
'265288',
'265290',
'265291',
'265292',
'265293',
'265294',
'256427',
'256428',
'265303',
'265305',
'265306',
'265307',
'265309',
'265310',
'265311',
'265313',
'265314',
'257738',
'257719',
'257716',
'257725',
'257741',
'260057',
'260082',
'260108',
'260109',
'260111',
'119499',
'121296',
'121506',
'121599',
'121775',
'121777',
'121821',
'121831',
'122214',
'122378',
'122586',
'125633',
'128613',
'128958',
'129009',
'129068',
'129073',
'129301',
'129337',
'129470',
'130024',
'131039',
'167387',
'168917',
'169790',
'170055',
'171199',
'171257',
'171443',
'189706',
'190147',
'190338',
'190340',
'190351',
'190426',
'190464',
'190721',
'190731',
'190733',
'190761',
'190768',
'190956',
'190964',
'190968',
'194075',
'194174',
'194192',
'194203',
'194213',
'194224',
'194227',
'194424',
'194428',
'194622',
'195167',
'195205',
'195689',
'195780',
'196051',
'196471',
'197202',
'197206',
'197234',
'208261',
'217575',
'217576',
'217636',
'217681',
'217689',
'217696',
'217702',
'217703',
'217704',
'217706',
'217707',
'217714',
'217727',
'217730',
'217756',
'217763',
'217770',
'217773',
'217789',
'217818',
'217833',
'217855',
'217868',
'217873',
'217875',
'217887',
'217891',
'217901',
'217905',
'217933',
'217956',
'217959',
'217980',
'218000',
'218001',
'218020',
'218024',
'218025',
'218029',
'218034',
'218047',
'218059',
'218069',
'218071',
'218096',
'218118',
'218133',
'218146',
'218191',
'218197',
'218215',
'218294',
'218296',
'218308',
'218432',
'218491',
'218737',
'218896',
'218923',
'219088',
'220925',
'220926',
'225708',
'225788',
'225812',
'226313',
'226785',
'233054',
'233469',
'234152',
'234329',
'234332',
'234336',
'234343',
'234344',
'234345',
'234352',
'234359',
'234365',
'234373',
'234428',
'234429',
'234447',
'234466',
'234469',
'234538',
'234539',
'234558',
'234561',
'234583',
'234625',
'234651',
'234670',
'234711',
'234718',
'234792',
'234847',
'234890',
'234896',
'234898',
'234907',
'234909',
'234936',
'235003',
'235310',
'235315',
'235318',
'235320',
'235327',
'235341',
'235470',
'235503',
'236434',
'237278',
'244971',
'245024',
'245025',
'245031',
'245033',
'245034',
'245035',
'245037',
'245038',
'245039',
'245040',
'245042',
'245043',
'245044',
'245045',
'247481',
'247539',
'247540',
'248225',
'249459',
'250015',
'250097',
'250098',
'250367',
'251554',
'251567',
'251745',
'251776',
'251824',
'251859',
'251906',
'251942',
'251946',
'251958',
'251962',
'251963',
'251974',
'251998',
'252000',
'252008',
'252009',
'252023',
'252040',
'252055',
'252056',
'252059',
'252063',
'252066',
'252067',
'252068',
'252069',
'252074',
'252075',
'252077',
'252374',
'252375',
'252376',
'252971',
'252992',
'253220',
'253351',
'253641',
'253683',
'253711',
'253723',
'253724',
'253726',
'253804',
'253849',
'253869',
'253876',
'253890',
'254031',
'254032',
'254033',
'254034',
'254261',
'254843',
'255925',
'255926',
'255927',
'255936',
'255941',
'256024',
'256028',
'256378',
'256459',
'256460',
'256471',
'256485',
'256552',
'256553',
'256563',
'256564',
'256603',
'256605',
'256635',
'256636',
'256659',
'256710',
'256711',
'256729',
'256730',
'256731',
'256735',
'256737',
'256739',
'256740',
'256741',
'256752',
'256867',
'256875',
'256876',
'256878',
'256927',
'256949',
'256958',
'256960',
'257060',
'257142',
'258734',
'258851',
'259800',
'259967',
'260304',
'260326',
'260730',
'265097',
'265490',
'270298')
    group by customer_code,regexp_replace(substr(cast(business_sign_time as string),1,7),'-','') 
)a
join 
csx_ads.csx_ads_sale_new_sign_customer_detail_1m b
on a.customer_code =b.customer_code and a.sign_month=b.month 
where b.performance_region_name='华东大区' 
-- and b.performance_province_name='上海' 
and a.sign_month=substr(b.first_sign_date,1,6) -- 限定是新签客户 
group by a.sign_month,b.customer_code
order by a.sign_month,max(b.first_sign_date),max(a.maxSignDate),b.customer_code
;

-- ------------新履约数据
drop table if exists csx_analyse_tmp.sale_detail_customer;
create table if not exists csx_analyse_tmp.sale_detail_customer as 
select
	substr(c.first_sales_date,1,6) as month,
	-- a.performance_region_name,
	-- a.performance_province_name,	
	-- a.performance_city_name,
	-- a.business_type_name,
	a.customer_code,
	sum(a.sale_amt)/10000 sale_amt,
	sum(a.profit)/10000 profit		
from 
	(select 
		*,
		min(sdt)over(partition by customer_code,business_type_code) as min_sdt 
	from csx_dws.csx_dws_sale_detail_di 
	where sdt >='20250101' and sdt <= '20250731' 
	and performance_region_name='华东大区' 
	and customer_code not in ('154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'154278',
'251646',
'251648',
'251649',
'251650',
'251651',
'251652',
'251653',
'251654',
'251656',
'251657',
'251660',
'251661',
'251662',
'251672',
'251673',
'251674',
'251675',
'256560',
'256559',
'256557',
'256555',
'256551',
'256545',
'256548',
'256431',
'256430',
'256429',
'256428',
'256427',
'256426',
'205971',
'256425',
'256590',
'256423',
'256422',
'256442',
'256436',
'256440',
'256438',
'256434',
'256433',
'256439',
'256441',
'256437',
'256435',
'257771',
'257770',
'257769',
'257750',
'257814',
'257747',
'257768',
'257767',
'257766',
'257765',
'257764',
'257763',
'251674',
'251673',
'251675',
'251651',
'251653',
'251654',
'251649',
'251672',
'257762',
'256560',
'256559',
'256557',
'256555',
'256551',
'256545',
'256548',
'256431',
'256430',
'256429',
'256428',
'256427',
'256426',
'205971',
'256425',
'256590',
'256423',
'256442',
'256438',
'256433',
'256439',
'256437',
'256435',
'125268',
'256545',
'258773',
'258790',
'258782',
'258776',
'256438',
'256442',
'256559',
'256440',
'256548',
'256555',
'256436',
'258789',
'256560',
'256434',
'256557',
'258792',
'258780',
'256551',
'258791',
'258774',
'258775',
'256423',
'258777',
'256425',
'256433',
'258778',
'257764',
'256430',
'251649',
'257765',
'257766',
'251653',
'257768',
'257770',
'251675',
'251654',
'256431',
'256590',
'205971',
'257767',
'257771',
'257763',
'257769',
'251672',
'256426',
'256427',
'257750',
'257747',
'251651',
'179439',
'259969',
'259970',
'259971',
'259972',
'259973',
'256430',
'205971',
'256426',
'256429',
'256431',
'256590',
'260076',
'259974',
'259975',
'259976',
'259977',
'259978',
'259979',
'259980',
'259981',
'259982',
'259983',
'259984',
'259985',
'256427',
'256428',
'260097',
'260098',
'260100',
'260102',
'260104',
'260105',
'260106',
'260107',
'179439',
'259969',
'259970',
'259971',
'259972',
'259973',
'256430',
'154278',
'205971',
'256426',
'256429',
'256431',
'256590',
'265286',
'265287',
'265288',
'265290',
'265291',
'265292',
'265293',
'265294',
'256427',
'256428',
'265303',
'265305',
'265306',
'265307',
'265309',
'265310',
'265311',
'265313',
'265314',
'257738',
'257719',
'257716',
'257725',
'257741',
'260057',
'260082',
'260108',
'260109',
'260111',
'119499',
'121296',
'121506',
'121599',
'121775',
'121777',
'121821',
'121831',
'122214',
'122378',
'122586',
'125633',
'128613',
'128958',
'129009',
'129068',
'129073',
'129301',
'129337',
'129470',
'130024',
'131039',
'167387',
'168917',
'169790',
'170055',
'171199',
'171257',
'171443',
'189706',
'190147',
'190338',
'190340',
'190351',
'190426',
'190464',
'190721',
'190731',
'190733',
'190761',
'190768',
'190956',
'190964',
'190968',
'194075',
'194174',
'194192',
'194203',
'194213',
'194224',
'194227',
'194424',
'194428',
'194622',
'195167',
'195205',
'195689',
'195780',
'196051',
'196471',
'197202',
'197206',
'197234',
'208261',
'217575',
'217576',
'217636',
'217681',
'217689',
'217696',
'217702',
'217703',
'217704',
'217706',
'217707',
'217714',
'217727',
'217730',
'217756',
'217763',
'217770',
'217773',
'217789',
'217818',
'217833',
'217855',
'217868',
'217873',
'217875',
'217887',
'217891',
'217901',
'217905',
'217933',
'217956',
'217959',
'217980',
'218000',
'218001',
'218020',
'218024',
'218025',
'218029',
'218034',
'218047',
'218059',
'218069',
'218071',
'218096',
'218118',
'218133',
'218146',
'218191',
'218197',
'218215',
'218294',
'218296',
'218308',
'218432',
'218491',
'218737',
'218896',
'218923',
'219088',
'220925',
'220926',
'225708',
'225788',
'225812',
'226313',
'226785',
'233054',
'233469',
'234152',
'234329',
'234332',
'234336',
'234343',
'234344',
'234345',
'234352',
'234359',
'234365',
'234373',
'234428',
'234429',
'234447',
'234466',
'234469',
'234538',
'234539',
'234558',
'234561',
'234583',
'234625',
'234651',
'234670',
'234711',
'234718',
'234792',
'234847',
'234890',
'234896',
'234898',
'234907',
'234909',
'234936',
'235003',
'235310',
'235315',
'235318',
'235320',
'235327',
'235341',
'235470',
'235503',
'236434',
'237278',
'244971',
'245024',
'245025',
'245031',
'245033',
'245034',
'245035',
'245037',
'245038',
'245039',
'245040',
'245042',
'245043',
'245044',
'245045',
'247481',
'247539',
'247540',
'248225',
'249459',
'250015',
'250097',
'250098',
'250367',
'251554',
'251567',
'251745',
'251776',
'251824',
'251859',
'251906',
'251942',
'251946',
'251958',
'251962',
'251963',
'251974',
'251998',
'252000',
'252008',
'252009',
'252023',
'252040',
'252055',
'252056',
'252059',
'252063',
'252066',
'252067',
'252068',
'252069',
'252074',
'252075',
'252077',
'252374',
'252375',
'252376',
'252971',
'252992',
'253220',
'253351',
'253641',
'253683',
'253711',
'253723',
'253724',
'253726',
'253804',
'253849',
'253869',
'253876',
'253890',
'254031',
'254032',
'254033',
'254034',
'254261',
'254843',
'255925',
'255926',
'255927',
'255936',
'255941',
'256024',
'256028',
'256378',
'256459',
'256460',
'256471',
'256485',
'256552',
'256553',
'256563',
'256564',
'256603',
'256605',
'256635',
'256636',
'256659',
'256710',
'256711',
'256729',
'256730',
'256731',
'256735',
'256737',
'256739',
'256740',
'256741',
'256752',
'256867',
'256875',
'256876',
'256878',
'256927',
'256949',
'256958',
'256960',
'257060',
'257142',
'258734',
'258851',
'259800',
'259967',
'260304',
'260326',
'260730',
'265097',
'265490',
'270298')
-- 	and performance_province_name='上海'
	) a
	left join  -- 首单日期
	(select 
	    customer_code,
		business_type_code,
		min(first_business_sale_date) first_sales_date
	from csx_dws.csx_dws_crm_customer_business_active_di
	where sdt ='current' 
	and first_business_sale_date>='20250101' 
	and first_business_sale_date<'20250801' 
	group by customer_code,business_type_code
	)c 
	on c.customer_code=a.customer_code and c.business_type_code=a.business_type_code 
where a.sdt>=c.first_sales_date and a.sdt<=regexp_replace(date_add(from_unixtime(unix_timestamp(c.first_sales_date,'yyyyMMdd'),'yyyy-MM-dd'),29),'-','') 
and c.customer_code is not null 
group by 
	substr(c.first_sales_date,1,6),
	-- a.performance_region_name,
	-- a.performance_province_name,	
	-- a.performance_city_name,
	-- a.business_type_name,
	a.customer_code
;

-- 所有客户履约数据
drop table if exists csx_analyse_tmp.sale_detail_customer_all;
create table if not exists csx_analyse_tmp.sale_detail_customer_all as 
select
	substr(a.sdt,1,6) as month,
	-- a.performance_region_name,
	-- a.performance_province_name,	
	-- a.performance_city_name,
	a.business_type_name,
	a.customer_code,
	sum(a.sale_amt)/10000 sale_amt,
	sum(a.profit)/10000 profit		
from 
	(select 
		* 
	from csx_dws.csx_dws_sale_detail_di 
	where sdt >='20250101' and sdt <= '20250730' 
	and performance_region_name='华东大区' 
-- 	and performance_province_name='上海'
	) a
	left join  -- 首单日期
	(select 
	    customer_code,
		business_type_code,
		min(first_business_sale_date) first_sales_date
	from csx_dws.csx_dws_crm_customer_business_active_di
	where sdt ='current' 
	group by customer_code,business_type_code
	)c 
	on c.customer_code=a.customer_code and c.business_type_code=a.business_type_code 
-- where substr(a.sdt,1,6)=substr(b.first_sign_date,1,6) 
group by 
	substr(a.sdt,1,6),
	-- a.performance_region_name,
	-- a.performance_province_name,	
	-- a.performance_city_name,
	a.business_type_name,
	a.customer_code
;

-- 最终数据表
drop table if exists csx_analyse_tmp.new_sign_customer_final;
create table if not exists csx_analyse_tmp.new_sign_customer_final as 
select 
	'销售' as type,
	a.month,
	'' as business_type_name,
	a.performance_province_name,
	a.performance_city_name,
	a.customer_code,
	a.customer_name,
	a.sales_user_name,
	a.supervisor_user_name,
	(case when d.employee_status='3' then '在职' else '离职' end) as employee_status_name,
	b.customer_code as sign_cus,
	c.customer_code as ly_cus,
	c.sale_amt,
	c.profit 
from 
	(select 
		*,
		substr(sdt,1,6) as month 
	from csx_dim.csx_dim_crm_customer_info 
	where sdt in ('20250131','20250228','20250331','20250430','20250531','20250630','20250730') 
	and performance_region_name='华东大区'
	) a 
	left join 
	csx_analyse_tmp.new_sign_customer b 
	on a.month=b.sign_month and a.customer_code=b.customer_code 
	left join 
	csx_analyse_tmp.sale_detail_customer c 
	on a.month=c.month and a.customer_code=c.customer_code 
	left join 
	(select 
		t1.* 
	from 
		(select 
			*,
			row_number()over(partition by employee_code order by employee_code) as pm  
		from csx_dim.csx_dim_basic_employee 
		where sdt='current' 
		) t1 
	where t1.pm=1 
	) d 
	on a.sales_user_number=d.employee_code 
union all 
select 
	'服务管家' as type,
	a1.month,
	a1.business_type_name,
	a3.performance_province_name,
	a3.performance_city_name,
	a1.customer_code,
	a3.customer_name,
	a3.sales_user_name,
	a5.sales_manager_user_name as supervisor_user_name,
	(case when a4.employee_status='3' then '在职' else '离职' end) as employee_status_name,
	a1.customer_code as sign_cus,
	a1.customer_code as ly_cus,
	a1.sale_amt,
	a1.profit  
from 
	csx_analyse_tmp.sale_detail_customer_all a1 
	left join 
	(select 
		*,
		substr(sdt,1,6) as month 
	from csx_analyse.csx_analyse_report_crm_customer_sale_service_manager_info_df 
	where sdt in ('20250131','20250228','20250331','20250430','20250531','20250630','20250730')   
	) a2 
	on a1.customer_code=a2.customer_no and a1.month=a2.month 
	left join 
	(select 
		*,
		substr(sdt,1,6) as month 
	from csx_dim.csx_dim_crm_customer_info 
	where sdt in ('20250131','20250228','20250331','20250430','20250531','20250630','20250730') 
	and performance_region_name='华东大区' 
	) a3  
	on a1.customer_code=a3.customer_code and a1.month=a3.month 
	left join 
	(select 
		t1.* 
	from 
		(select 
			*,
			row_number()over(partition by employee_code order by employee_code) as pm  
		from csx_dim.csx_dim_basic_employee 
		where sdt='current' 
		) t1 
	where t1.pm=1 
	) a4 
	on a3.sales_user_number=a4.employee_code 
	left join 
	(select 
	    sales_user_number,
	    sales_manager_user_name 
	from csx_dim.csx_dim_crm_customer_info  
	where sdt='current' 
	group by 
	    sales_user_number,
	    sales_manager_user_name 
	) a5 
	on a3.sales_user_number=a5.sales_user_number 
;


-- --------------------------------------------------------------------------
-- ------------服务管家Q2每个月维护的客户数及业绩数据
select 
	type as `数据类型`,
	month as `月份`,
	business_type_name as `业务类型`,
	performance_province_name as `省区`,
	performance_city_name as `城市`,
	customer_code as `客户编码`,
	customer_name as `客户名称`,
	sales_user_name as `销售员`,
	supervisor_user_name as `销售经理`,
	employee_status_name as `销售员在职和离职`,
	sign_cus as `是否是新签约客户`,
	ly_cus as `是否是新履约客户`,
	sale_amt as `销售额`,
	profit as `毛利额`  
from csx_analyse_tmp.new_sign_customer_final 
